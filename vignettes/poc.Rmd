---
title: "poc"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{poc}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

## Load Data

**Disclaimer**: Proof-of-concept with `eval=FALSE`, don't expect anything here to work.
Implementation might live in other branches.

Example: terra package

`demo_stack` generates a raster stack with 5 layers (4 predictor variables and 1 response variable) with a total size of 500MB. 
The file is written to disk and the stack is removed to free up memory.

```{r}
pkgload::load_all()

set.seed(42)

# see https://github.com/rspatial/terra/issues/30 for "Error in (function (x)  : attempt to apply non-function" -> does NOT affect usage
stack = demo_stack(size = 500, layers = 5)
# FIXME: is only 241 MB for me? and like 1,3 GB in mem
terra::writeRaster(stack, "demo_stack_500mb.tif", overwrite = TRUE)
rm(stack)
```

A mlr3 classification `task` is created and an SVM learner is fitted with the randomly sampled raster cells.

```{r}
stack = terra::rast("demo_stack_500mb.tif")
backend = DataBackendSpatRaster$new(stack)
task = as_task_classif(backend, target = "y", positive = "TRUE")
```

```{r}
learner_svm = lrn("classif.svm")
# requires mlr3 > 0.11.0-9000
learner_svm$parallel_predict = TRUE
learner_svm$train(task, row_ids = sample(1:task$nrow, 500))
```

## Prediction

Prediction happens on 12 Mio values (per layer), so 60 Mio values when predicting on 5 layers.

Takes ~ 32 seconds.

```{r}
library(future)
# plan("multisession", workers = 2)
time = Sys.time()
options(future.globals.onReference = "error")

pred = with_future(future::multisession,
  predict_spatial(task, learner_svm, filename = "target.tif"),
  workers = 2)

Sys.time() - time
```


```{r}
library(future)
# plan("multisession", workers = 2)
time = Sys.time()
options(future.globals.onReference = "error")

pred = with_future(future::multisession,
  predict_spatial_newdata(stack, learner_svm, filename = "target.tif"),
  workers = 2
)
Sys.time() - time
```

Takes ~ 1,04 min.

```{r}
library(future)
plan(sequential)
time = Sys.time()
pred = predict_spatial(task, learner_svm, filename = "target.tif")
Sys.time() - time
```

## Native prediction

~ 51 secs

```{r}
# fit e1071 svm
svm_raw = e1071::svm(y ~ ., data = task$data()[sample(1:task$nrow, 500)], )

time = Sys.time()
terra_pred_ras = terra::predict(task$backend$stack, svm_raw)
Sys.time() - time
```

## Compare


```{r}
# load mlr3 tif
mlr3_pred_ras = terra::rast("target.tif")

waldo::compare(mlr3_pred_ras, terra_pred_ras)
```
