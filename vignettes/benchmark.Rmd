---
title: "Benchmarking parallel predictions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{benchmark}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



For the speed comparison, we are using a somewhat larger `SpatRaster` object to actually showcase some differences.


```r
library(mlr3)
library(mlr3learners)
library(mlr3spatial)
library(future)
library(bench)

stack = demo_stack(size = 500, layers = 5)
backend = DataBackendSpatRaster$new(stack)
task = as_task_classif(backend, target = "y", positive = "TRUE")

stack_rasterbrick = demo_stack_rasterbrick(size = 50, layers = 5)
backend_raster = DataBackendRasterBrick$new(stack_rasterbrick)
task_rasterbrick = as_task_classif(backend, target = "y", positive = 1)

learner_svm = lrn("classif.svm")
learner_svm$parallel_predict = TRUE
set.seed(42)
row_ids = sample(1:task$nrow, 500)
learner_svm$train(task, row_ids = row_ids)

set.seed(42)
svm_raw = e1071::svm(y ~ ., data = task$data()[row_ids])

bm = bench::mark(
  "mlr3-sequential" = {
    plan(multisession, workers = 1)
    predict_spatial_newdata(learner_svm, stack)
  },

  "terra-sequential" = terra::predict(task$backend$stack, svm_raw, cores = 1, cpkgs = "e1071"),
  <!-- # "raster-sequential" = raster::predict(task$backend$stack, svm_raw, cores = 1, cpkgs = "e1071"), -->

  "mlr3-4-cores" = {
    plan(multisession, workers = 4)
    predict_spatial_newdata(learner_svm, stack)
  },

  "terra-4-cores" = terra::predict(task$backend$stack, svm_raw, cores = 4, cpkgs = "e1071"),

  check = FALSE, filter_gc = FALSE, min_iterations = 3, memory = FALSE)

bm$mem_alloc = NULL
bm$`itr/sec` = NULL
bm$result = NULL
bm$`gc/sec` = NULL
bm$memory = NULL

print(bm)
#> # A tibble: 4 × 8
#>   expression            min   median n_itr  n_gc total_time time           gc              
#>   <bch:expr>       <bch:tm> <bch:tm> <int> <dbl>   <bch:tm> <list>         <list>          
#> 1 mlr3-sequential     1.55m    1.56m     3    33      4.68m <bench_tm [3]> <tibble [3 × 3]>
#> 2 terra-sequential    1.68m    1.71m     3    30      5.11m <bench_tm [3]> <tibble [3 × 3]>
#> 3 mlr3-4-cores       46.63s   47.22s     3    15      2.38m <bench_tm [3]> <tibble [3 × 3]>
#> 4 terra-4-cores       1.73m    1.75m     3    18      5.25m <bench_tm [3]> <tibble [3 × 3]>
```


```r
library(ggplot2)
autoplot(bm, "ridge")
#> Picking joint bandwidth of 0.00322
```

![Benchmark plot](plot-benchmark-1.png)
