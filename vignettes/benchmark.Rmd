---
title: "Benchmarking parallel predictions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Benchmarking parallel predictions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



For the speed comparison, we are using a somewhat larger `SpatRaster` object to actually showcase some differences.


```r
library(mlr3)
library(mlr3learners)
library(mlr3spatial)
library(future)
library(bench)

# SpatRaster demo stack
stack = demo_stack_spatraster(size = 125, layers = 5)
backend = DataBackendSpatRaster$new(stack)
task = as_task_classif(backend, target = "y", positive = "TRUE")

# RasterBrick demo stack
stack_rasterbrick = demo_stack_rasterbrick(size = 125, layers = 5)
backend_raster = DataBackendRasterBrick$new(stack_rasterbrick, response = "y", response_is_factor = TRUE)
task_rasterbrick = as_task_classif(backend_raster, target = "y", positive = "1")

# SpatRaster learner
learner_svm = lrn("classif.svm")
learner_svm$parallel_predict = TRUE
set.seed(42)
row_ids = sample(1:task$nrow, 500)
learner_svm$train(task, row_ids = row_ids)

e1071svm = e1071::svm(y ~ ., task$data(rows = row_ids))

# RasterBrick learner
learner_svm_rasterbrick = lrn("classif.svm")
learner_svm_rasterbrick$parallel_predict = TRUE
set.seed(42)
row_ids = sample(1:task_rasterbrick$nrow, 500)
learner_svm_rasterbrick$train(task_rasterbrick, row_ids = row_ids)
```


```r
bm = bench::mark(
  "1-mlr3-terra-sequential" = {
    plan(multisession, workers = 1)
    predict_spatial_newdata(learner_svm, stack)
  },

  "2-mlr3-raster-sequential" = {
    plan(multisession, workers = 1)
    predict_spatial_newdata(learner_svm_rasterbrick, stack_rasterbrick)
  },

  "3-terra-sequential" = terra::predict(stack, e1071svm, cores = 1, cpkgs = "e1071"),
  "4-raster-sequential" = raster::predict(stack_rasterbrick, e1071svm),

  "5-mlr3-terra-4-cores" = {
    plan(multisession, workers = 4)
    predict_spatial_newdata(learner_svm, stack)
  },

  "6-mlr3-raster-4-cores" = {
    plan(multisession, workers = 4)
    predict_spatial_newdata(learner_svm_rasterbrick, stack_rasterbrick)
  },

  "7-terra-4-cores" = terra::predict(stack, e1071svm, cores = 4, cpkgs = "e1071"),

  check = FALSE, filter_gc = FALSE, min_iterations = 3, memory = FALSE)

bm$mem_alloc = NULL
bm$`itr/sec` = NULL
bm$result = NULL
bm$`gc/sec` = NULL
bm$memory = NULL

print(bm)
#> # A tibble: 7 × 8
#>   expression                    min   median n_itr  n_gc total_time time           gc              
#>   <bch:expr>               <bch:tm> <bch:tm> <int> <dbl>   <bch:tm> <list>         <list>          
#> 1 1-mlr3-terra-sequential     24.4s    25.3s     3    21      1.26m <bench_tm [3]> <tibble [3 × 3]>
#> 2 2-mlr3-raster-sequential    29.3s    29.4s     3    13      1.48m <bench_tm [3]> <tibble [3 × 3]>
#> 3 3-terra-sequential          26.7s      27s     3    13      1.35m <bench_tm [3]> <tibble [3 × 3]>
#> 4 4-raster-sequential         24.2s    24.3s     3     9      1.22m <bench_tm [3]> <tibble [3 × 3]>
#> 5 5-mlr3-terra-4-cores        15.3s    15.6s     3     5     47.33s <bench_tm [3]> <tibble [3 × 3]>
#> 6 6-mlr3-raster-4-cores       14.4s    14.5s     3     4      45.8s <bench_tm [3]> <tibble [3 × 3]>
#> 7 7-terra-4-cores             38.8s    39.7s     3     5         2m <bench_tm [3]> <tibble [3 × 3]>
```


```r
library(ggplot2)
autoplot(bm, "ridge")
#> Loading required namespace: tidyr
#> Picking joint bandwidth of 0.00734
```

![Benchmark plot](./plot-benchmark-1.png)


