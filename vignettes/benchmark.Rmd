---
title: "Benchmark Parallel Predictions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Benchmark Parallel Predictions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(mlr3spatial)
library(mlr3learners)
library(future)
```

# 10 Megabyte Raster in Memory with mlr3

Train learner on task.

```{r}
stack = generate_stack(list(
  numeric_layer("x_1"),
  factor_layer("y", levels = c("a", "b"))),
layer_size = 10)
vector = sample_stack(stack, n = 100)
task_train = as_task_classif(vector, id = "test_vector", target = "y")
learner = lrn("classif.ranger", num.threads = 1)
learner$train(task_train)
```

Predict.

```{r}
stack$y = NULL
task_predict = as_task_classif(stack, id = "test")
learner$parallel_predict = TRUE
```

Benchmark

```{r}
bm = bench::mark(

  "01-mlr3-1-cores" = {
    plan(sequential)
    pred = predict_spatial(task_predict, learner, chunksize = 10L)
  },

  "02-mlr3-2-cores" = {
    plan(multicore, workers = 2)
    pred = predict_spatial(task_predict, learner, chunksize = 10L)
  },

  "03-mlr3-4-core" = {
    plan(multicore, workers = 4)
    pred = predict_spatial(task_predict, learner, chunksize = 10L)
  },

  check = FALSE, filter_gc = FALSE, min_iterations = 3,
  max_iterations = 3, memory = FALSE)

saveRDS(bm, "bm_1.rda")
```
