---
title: "Vector data use case: `meuse` dataset"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vector data use case: `meuse` dataset}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The following code showcases a very simple example how to use an `sf` object as a `DataBackend` and a direct input into `predict_spatial_newdata()`.

Here, the `meuse` dataset represents the use case for a spatial points dataset (= vector dataset).

Note that this examples omits hyperparameter tuning when training the model and also does not perform a cross-validation for performance estimation.
Both should be done in a real-world scenario.

```{r }
library("mlr3")
library("mlr3learners")
library("mlr3spatial")
# for meuse data
library("sp")
library("sf")
library("mapview")

data(meuse)
sf_meuse = st_as_sf(meuse, coords = c("x", "y"), crs = "epsg:28992")
sf_meuse = na.omit(sf_meuse)

# create train and test sets in a reproducible way
set.seed(42)
train = sample(1:nrow(sf_meuse), 100)
test = setdiff(1:nrow(sf_meuse), train)

# create mlr3 backend from sf data
backend = as_sf_backend(sf_meuse[train, ])

# create external test set
newdata = sf_meuse[test, ]

# create "Random Forest" learner and train it
learner = lrn("regr.ranger")
task = as_task_regr(backend, "cadmium")
learner$train(task)

# set the output file and predict with the learner
file = tempfile("out", fileext = ".gpkg")
pred = predict_spatial_newdata(learner, newdata, filename = file)

# calculate "Root Mean Square Error" (RMSE) measure
pred$score(msr("regr.rmse"))

# calculate residuals
pred_res = abs(pred$truth - pred$response)

# read geopackage which was created during the `predict_spatial_newdata()` call
gpkg = st_read(file, quiet = TRUE)
gpkg$pred = pred_res

# visualize residuals via mapview()
mapview(gpkg, zcol = "pred", alpha = 1, layer.name = "Residuals", cex = 3) +
  mapview(sf_meuse[train, ], colour = "cyan", col.regions = "cyan", cex = 2, layer.name = "Training data")
```
