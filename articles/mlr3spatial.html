<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Getting started • mlr3spatial</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/journal/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<link href="../extra.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Getting started">
<meta property="og:description" content="mlr3spatial">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a href="https://mlr-org.com"><img src="https://raw.githubusercontent.com/mlr-org/mlr3/master/man/figures/logo.png" id="hexlogo" alt="mlr-org"></a>
        <a class="navbar-brand" href="../index.html">mlr3spatial <small>v0.0.0.9001</small></a>
      </div>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-alt"></span>
     
    Reference
  </a>
</li>
<li>
  <a href="https://mlr3book.mlr-org.com">
    <span class="fa fa-link"></span>
     
    mlr3book
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/benchmark.html">Benchmarking parallel predictions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/mlr3spatial.html">Get started</a>
</li>
        <li>
  <a href="https://github.com/mlr-org/mlr3spatial/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://lmmisld-lmu-stats-slds.srv.mwn.de/mlr_invite/">
    <span class="fa fa-comments"></span>
     
  </a>
</li>
<li>
  <a href="https://stackoverflow.com/questions/tagged/mlr3">
    <span class="fab fa-stack-overflow"></span>
     
  </a>
</li>
<li>
  <a href="https://mlr-org.com/">
    <span class="fa fa-rss"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="mlr3spatial_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Getting started</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mlr-org/mlr3spatial/blob/master/vignettes/mlr3spatial.Rmd"><code>vignettes/mlr3spatial.Rmd</code></a></small>
      <div class="hidden name"><code>mlr3spatial.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>{mlr3spatial} adds [mlr3::DataBackend]s for spatial classes ([terra::SpatRaster], [raster::brick], [sf::sf]). In addition, direct predictions to objects of these classes are supported. The direct return is a [mlr3::Prediction] object as for all other <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> returns in the {mlr3} ecosystem. Besides, the respective spatial objects can be written to disk and loaded into the session for further analysis.</p>
<p>Essentially, {mlr3spatial} takes of the burden of converting spatial objects into a plain <code>data.table</code> and then coercing the predicted values back into the spatial object while making sure to not loose the spatial reference.</p>
<p>There is one more goodie in the bag. Thanks to mlr3’s ability to predict in parallel with any learner, {mlr3spatial} prediction can also make use of future-based parallelization and speed up the predictions of spatial objects. Often enough, spatial predictions are quite large (in the millions of values) and efficient parallelization can save some time here. See the vignette on <a href="https://mlr3spatial.mlr-org.com/articles/benchmark.html">“Benchmarking parallel predictions”</a> for details.</p>
<p>In the following, we showcase a step-by-step example how to handle a multi-layer raster object from package {terra}.</p>
</div>
<div id="use-case---stars-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#use-case---stars-objects" class="anchor"></a>Use Case - {stars} objects</h2>
<div id="data-preparation" class="section level3">
<h3 class="hasAnchor">
<a href="#data-preparation" class="anchor"></a>Data Preparation</h3>
<p>Spatial objects are not included as built-in datasets into the package due to their size. Some helper functions like <code><a href="../reference/demo_stack_spatraster.html">demo_stack_spatraster()</a></code> are available to create such.</p>
<p>The <code>SpatRaster</code> consists of 500 columns and rows and contains five layers with each layer representing a variable.</p>
<p>The <code>"Error in (function (x)  : attempt to apply non-function"</code> error can be ignored - this is an internal issue of the {terra} package during object creation and does not affect usage.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3.mlr-org.com">"mlr3"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3spatial.mlr-org.com">"mlr3spatial"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://mlr3learners.mlr-org.com">"mlr3learners"</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://r-spatial.github.io/stars/">"stars"</a></span><span class="op">)</span>
<span class="co">#&gt; Loading required package: abind</span>
<span class="co">#&gt; Loading required package: sf</span>
<span class="co">#&gt; Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st">"e1071"</span><span class="op">)</span></code></pre></div>
<p>First, a {mlr3} classification <code>task</code> is created and a SVM learner is fitted with randomly sampled raster cells.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="va">stack</span> <span class="op">=</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span>

<span class="va">backend</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_data_backend.html">as_data_backend</a></span><span class="op">(</span><span class="va">stack</span><span class="op">)</span>
<span class="va">task</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/as_task_regr.html">as_task_regr</a></span><span class="op">(</span><span class="va">backend</span>, target <span class="op">=</span> <span class="st">"layer.1"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">task</span><span class="op">)</span>
<span class="co">#&gt; &lt;TaskRegr:backend&gt; (122848 x 6)</span>
<span class="co">#&gt; * Target: layer.1</span>
<span class="co">#&gt; * Properties: -</span>
<span class="co">#&gt; * Features (5):</span>
<span class="co">#&gt;   - dbl (5): layer.2, layer.3, layer.4, layer.5, layer.6</span></code></pre></div>
<p>For large raster files with millions of values it helps to predict in parallel. To enable this, set <code>learner$parallel_predict = TRUE</code> and initiate a parallel plan via {future}. This required {mlr3} &gt;= 0.12.0.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">learner_svm</span> <span class="op">=</span> <span class="fu"><a href="https://mlr3.mlr-org.com/reference/mlr_sugar.html">lrn</a></span><span class="op">(</span><span class="st">"regr.svm"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span>
<span class="va">row_ids</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">task</span><span class="op">$</span><span class="va">nrow</span>, <span class="fl">500</span><span class="op">)</span>
<span class="va">learner_svm</span><span class="op">$</span><span class="fu">train</span><span class="op">(</span><span class="va">task</span>, row_ids <span class="op">=</span> <span class="va">row_ids</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">learner_svm</span><span class="op">)</span>
<span class="co">#&gt; &lt;LearnerRegrSVM:regr.svm&gt;</span>
<span class="co">#&gt; * Model: svm</span>
<span class="co">#&gt; * Parameters: list()</span>
<span class="co">#&gt; * Packages: e1071</span>
<span class="co">#&gt; * Predict Type: response</span>
<span class="co">#&gt; * Feature types: logical, integer, numeric</span>
<span class="co">#&gt; * Properties: -</span></code></pre></div>
</div>
<div id="prediction" class="section level3">
<h3 class="hasAnchor">
<a href="#prediction" class="anchor"></a>Prediction</h3>
<p>For prediction <code><a href="../reference/predict_spatial.html">predict_spatial()</a></code> is used. It will return a raster file which contains the predictions. Users can select which R spatial format the returned raster should have.</p>
<p>In the following, we will compare the way to conduct the prediction using {mlr3spatial} with the “native” way of fitting an <code><a href="https://rdrr.io/pkg/e1071/man/svm.html">e1071::svm()</a></code> model and predicting with <code><a href="https://rdrr.io/pkg/terra/man/predict.html">terra::predict()</a></code>.</p>
<div id="mlr3spatial" class="section level4">
<h4 class="hasAnchor">
<a href="#mlr3spatial" class="anchor"></a>mlr3spatial</h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ras</span> <span class="op">=</span> <span class="fu"><a href="../reference/predict_spatial.html">predict_spatial</a></span><span class="op">(</span><span class="va">task</span>, <span class="va">learner_svm</span>, format <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="co">#&gt; Warning in showSRID(SRS_string, format = "PROJ", multiline = "NO", prefer_proj =</span>
<span class="co">#&gt; prefer_proj): Discarded datum unknown in Proj4 definition</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span> <span class="op">=</span> <span class="st">"cadmium"</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">ras</span><span class="op">)</span>
<span class="co">#&gt; stars object with 2 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;              Min.  1st Qu.   Median     Mean  3rd Qu.     Max.</span>
<span class="co">#&gt; cadmium  57.59748 67.45409 78.34238 78.61442 89.09275 110.2793</span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;   from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span></code></pre></div>
</div>
<div id="stars" class="section level4">
<h4 class="hasAnchor">
<a href="#stars" class="anchor"></a>stars</h4>
<p>Since the layers are merged in a {stars} object, one first need to split them up and convert them into a regular data.table. Next, the column names need to be adjusted to match the ones of the training data. Afterwards, the <code>data.frame</code> generic of <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> can be called. Finally, the predictions need to be injected into a stars object again.</p>
<p>(All of these steps are happening internally in {mlr3spatial}).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">svm_e1071</span> <span class="op">=</span> <span class="fu">e1071</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/e1071/man/svm.html">svm</a></span><span class="op">(</span><span class="va">layer.1</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="fu">data</span><span class="op">(</span>rows <span class="op">=</span> <span class="va">row_ids</span><span class="op">)</span><span class="op">)</span>
<span class="va">stars_stack</span> <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/merge.html">split</a></span><span class="op">(</span><span class="va">stack</span>, <span class="st">"band"</span><span class="op">)</span><span class="op">)</span>
<span class="va">stars_stack</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"X1"</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">stars_stack</span><span class="op">)</span> <span class="op">=</span> <span class="va">task</span><span class="op">$</span><span class="va">feature_names</span>

<span class="va">stars_pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">svm_e1071</span>, <span class="va">stars_stack</span><span class="op">)</span>

<span class="co"># subset stars object to one band only</span>
<span class="va">stars_pred_ras</span> <span class="op">=</span> <span class="va">stack</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span>
<span class="co"># rename the layer name</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">stars_pred_ras</span><span class="op">)</span> <span class="op">=</span> <span class="st">"pred"</span>
<span class="co"># assign predictions</span>
<span class="va">stars_pred_ras</span><span class="op">$</span><span class="va">pred</span> <span class="op">=</span> <span class="va">stars_pred</span>

<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">stars_pred_ras</span><span class="op">)</span>
<span class="co">#&gt; stars object with 3 dimensions and 1 attribute</span>
<span class="co">#&gt; attribute(s):</span>
<span class="co">#&gt;           Min.  1st Qu.   Median     Mean  3rd Qu.     Max.</span>
<span class="co">#&gt; pred  57.59748 67.45409 78.34238 78.61442 89.09275 110.2793</span>
<span class="co">#&gt; dimension(s):</span>
<span class="co">#&gt;      from  to  offset delta                       refsys point values x/y</span>
<span class="co">#&gt; x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">#&gt; y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">#&gt; band    1   1      NA    NA                           NA    NA   NULL</span></code></pre></div>
</div>
</div>
<div id="output-consistency" class="section level3">
<h3 class="hasAnchor">
<a href="#output-consistency" class="anchor"></a>Output consistency</h3>
<p>Now that we have executed two predictions, we would like to verify that these are actually identical.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">stars_pred_ras</span><span class="op">$</span><span class="va">pred</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">ras</span><span class="op">$</span><span class="va">cadmium</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
<div id="visualization" class="section level3">
<h3 class="hasAnchor">
<a href="#visualization" class="anchor"></a>Visualization</h3>
<p>Finally we can plot the predictions. The color vector is extract from the viridis color palette via <code><a href="https://rdrr.io/r/base/dput.html">dput(viridis::viridis_pal()(12))</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/stars/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ras</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#440154FF"</span>, <span class="st">"#482173FF"</span>, <span class="st">"#433E85FF"</span>, <span class="st">"#38598CFF"</span>, <span class="st">"#2D708EFF"</span>,
  <span class="st">"#25858EFF"</span>, <span class="st">"#1E9B8AFF"</span>, <span class="st">"#2BB07FFF"</span>, <span class="st">"#51C56AFF"</span>, <span class="st">"#85D54AFF"</span>,
  <span class="st">"#C2DF23FF"</span>, <span class="st">"#FDE725FF"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="mlr3spatial_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Marc Becker, <a href="https://pat-s.me">Patrick Schratz</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
